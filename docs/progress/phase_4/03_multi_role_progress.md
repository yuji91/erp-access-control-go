
## 📋 **実装手順**

### **Phase 1: データベース・モデル準備** ✅ **完了**
1. ✅ `user_roles` テーブル作成 (`migrations/02_add_user_roles_table.sql`)
2. ✅ `UserRole` モデル実装 (`models/user_roles.go`)
3. ✅ `User`, `Role` モデル更新 (`models/users.go`, `models/roles.go`)
4. ✅ 既存データ移行スクリプト実行

### **Phase 2: サービス層実装** ✅ **完了**
1. ✅ 複数ロール権限取得メソッド実装 (`models/users.go`)
2. ✅ ロール管理メソッド実装 (`models/users.go`)
3. ✅ `PermissionService` 更新 (`internal/services/permission.go`)
4. ✅ 既存メソッドの後方互換性確保

### **Phase 3: ミドルウェア・API更新** ✅ **完了**
1. ✅ 認証ミドルウェアの複数ロール対応 (`internal/middleware/auth.go`)
2. ✅ JWT Claims への複数ロール情報追加 (`pkg/jwt/jwt.go`)
3. ✅ API エンドポイントでのロール管理 (`internal/handlers/user_role.go`, `internal/services/user_role.go`)
4. ✅ APIルーティング設定 (`cmd/server/main.go`)
5. ✅ **完了**: 認証ハンドラーの実装 (`internal/handlers/auth.go`)
   - ログイン機能
   - ログアウト機能
   - トークンリフレッシュ機能
   - プロフィール取得機能
   - パスワード変更機能

### **Phase 4: テスト・検証** ❌ **未実装**
1. ❌ 単体テスト実装
2. ❌ 統合テスト実装
3. ❌ パフォーマンステスト
4. ❌ セキュリティテスト

### **Phase 5: 旧システム削除** ❌ **未実装**
1. ❌ `User.RoleID` フィールド削除
2. ❌ 旧コードのクリーンアップ
3. ❌ 最終マイグレーション実行

## 🚧 **現在の課題**

### **1. テストデータ不足** ⚠️ **重要**
- 初期ユーザー・ロールデータが未投入
- APIテスト用のサンプルデータが必要
- データベースマイグレーションの実行が必要

### **2. データベース接続設定** ✅ **解決済み**
- 環境変数設定の問題は解決
- Docker環境との連携は正常動作

### **3. 次のステップ**
- **Phase 4: テスト・検証** の開始
- 単体テスト実装
- 統合テスト実装
- 実際のAPI動作確認（Postman/curl）

## 🎯 **期待効果**

### **機能面**
- 複雑な組織構造への対応
- 一時的権限付与の柔軟性
- ロール管理の細粒度制御

### **運用面**
- 権限管理の自動化
- 監査トレーサビリティの向上
- セキュリティポリシーの強化

この実装により、より実用的で柔軟なアクセス制御システムが実現できます。
