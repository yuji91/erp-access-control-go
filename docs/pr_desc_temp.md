# エラーハンドリング改善PR

## 概要

認証・認可処理におけるエラーハンドリングの包括的な改善を実施します。主な目的は、より適切なエラーレスポンスの提供、ロギングの最適化、およびセキュリティの向上です。

## 背景

現在、以下の問題が確認されています：

1. 認証エラー時に不適切なHTTPステータスコード（500）を返却
2. エラーメッセージの詳細度が不十分
3. デバッグログが本番環境でも出力される可能性

## 変更内容

### 1. エラーレスポンスの標準化

- HTTPステータスコードの適正化
  - 認証エラー → 401 Unauthorized
  - バリデーションエラー → 400 Bad Request
  - サーバーエラー → 500 Internal Server Error

- 一貫性のあるエラーレスポンス形式の導入
```json
{
  "code": "ERROR_CODE",
  "message": "人間が読みやすいエラーメッセージ",
  "details": {
    "field": "エラーが発生したフィールド",
    "reason": "具体的な理由"
  }
}
```

### 2. エラーハンドリングの強化

- エラー種別の明確な定義と分類
  - 認証エラー（AuthenticationError）
  - 認可エラー（AuthorizationError）
  - バリデーションエラー（ValidationError）
  - ビジネスロジックエラー（BusinessError）
  - システムエラー（SystemError）

- ミドルウェアでのエラーハンドリング実装
  - パニックリカバリーの強化
  - エラー種別に応じた適切なレスポンス生成

### 3. ロギング改善

- 環境別ログレベルの設定
  - 開発環境：DEBUG
  - ステージング環境：INFO
  - 本番環境：WARN以上

- センシティブ情報の保護
  - パスワードやトークンのマスキング
  - 個人情報の適切な取り扱い

- 構造化ログの導入
  - JSON形式でのログ出力
  - トレースIDの付与
  - タイムスタンプの標準化

## 影響を受けるファイル

- `internal/handlers/auth.go`
  - 認証エラーハンドリングの実装
  - エラーレスポンスの標準化

- `internal/middleware/auth.go`
  - エラーハンドリングミドルウェアの追加
  - パニックリカバリーの強化

- `pkg/errors/errors.go`
  - カスタムエラー型の定義
  - エラーマッピングの実装

- `pkg/logger/logger.go`
  - 環境別ログ設定の実装
  - 構造化ログの導入

## テスト

- 各エラーケースのユニットテスト追加
- エラーハンドリングの統合テスト実装
- ログ出力のテスト追加

## セキュリティ上の考慮事項

- エラーメッセージに機密情報を含めない
- スタックトレースは開発環境でのみ表示
- 本番環境では一般的なエラーメッセージを使用

## 期待される効果

1. クライアント開発者の利便性向上
   - 適切なHTTPステータスコード
   - 理解しやすいエラーメッセージ
   - 一貫性のあるレスポンス形式

2. デバッグ効率の向上
   - 構造化されたログ
   - 環境に応じた適切なログレベル
   - トレーサビリティの向上

3. セキュリティの強化
   - センシティブ情報の保護
   - 適切なエラー情報の制御
   - パニックからの安全な回復

## レビュー時の確認ポイント

- エラーレスポンスの一貫性
- ログレベルの適切性
- セキュリティ上の考慮事項
- テストカバレッジ
- パフォーマンスへの影響 