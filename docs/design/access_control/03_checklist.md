# 🗂️ **ERP Access Control API 開発チェックリスト**

> **Permission Matrix + Policy Object ハイブリッド構成**の実装に必要な全要素を網羅

---

## 📋 **チェックリスト概要**

| ステータス | 項目数 | 説明 |
|------------|--------|------|
| ✅ **完了** | 12 | 設計・環境構築フェーズ |
| 🔄 **進行中** | 0 | 現在作業中の項目 |
| ⏳ **未着手** | 45 | 実装予定の項目 |
| **合計** | **57** | 全開発タスク |

---

## 🎯 **Phase 1: プロジェクト基盤構築**

### **1.1 環境・インフラ設定**

- [x] **Go 1.24.5 インストール** _(Darwin/ARM64)_
- [x] **ライブラリ選定完了** _(go.mod定義済み)_
- [x] **依存関係ダウンロード** _(go mod tidy実行済み)_
- [ ] **プロジェクト構造作成**
  ```bash
  mkdir -p cmd/server internal/{handlers,services,middleware,config} api migrations pkg
  ```
- [ ] **環境変数管理** _(.env, Viper設定)_
- [ ] **ログ設定** _(uber-go/zap設定)_
- [ ] **エラーハンドリング仕組み** _(カスタムエラー型定義)_

### **1.2 設定管理**

- [ ] **`internal/config/config.go`** _(Viper設定構造体)_
- [ ] **`.env.example`** _(環境変数テンプレート)_
- [ ] **`config.yaml`** _(デフォルト設定ファイル)_
- [ ] **環境別設定** _(dev/staging/prod)_

---

## 🗄️ **Phase 2: データベース基盤**

### **2.1 データベース接続**

- [x] **PostgreSQL スキーマ設計** _(migration/02.sql)_
- [x] **GORMモデル定義** _(models/*.go 10ファイル)_
- [ ] **データベース接続設定** _(GORM + PostgreSQL Driver)_
- [ ] **マイグレーション実行** _(golang-migrate/migrate)_
- [ ] **接続プール設定** _(MaxOpenConns, MaxIdleConns)_
- [ ] **ヘルスチェック** _(DB Ping機能)_

### **2.2 データモデル検証**

- [ ] **Department モデルテスト** _(階層構造検証)_
- [ ] **Role モデルテスト** _(権限継承検証)_
- [ ] **User モデルテスト** _(ステータス管理検証)_
- [ ] **Permission マトリックステスト** _(RBAC検証)_
- [ ] **UserScope モデルテスト** _(JSONB検証)_
- [ ] **AuditLog モデルテスト** _(監査ログ検証)_

---

## 🌐 **Phase 3: API基盤構築**

### **3.1 Ginフレームワーク設定**

- [ ] **`cmd/server/main.go`** _(アプリケーションエントリポイント)_
- [ ] **Ginエンジン初期化** _(ミドルウェア設定含む)_
- [ ] **ルーティング設定** _(RESTful API構造)_
- [ ] **ミドルウェア統合** _(CORS, セキュリティ, ログ)_

### **3.2 OpenAPI/Swagger設定**

- [ ] **`api/openapi.yaml`** _(API仕様定義)_
- [ ] **Swagger UI統合** _(gin-swagger)_
- [ ] **スキーマ定義** _(リクエスト・レスポンス型)_
- [ ] **API ドキュメント自動生成** _(swaggo/swag)_

### **3.3 ミドルウェア実装**

- [ ] **CORS設定** _(gin-contrib/cors)_
- [ ] **セキュリティヘッダー** _(gin-contrib/secure)_
- [ ] **Rate Limiting** _(golang.org/x/time/rate)_
- [ ] **Request ID** _(gin-contrib/requestid)_
- [ ] **Gzip圧縮** _(gin-contrib/gzip)_
- [ ] **リクエストログ** _(構造化ログ出力)_

---

## 🔐 **Phase 4: 認証・認可システム**

### **4.1 JWT認証**

- [ ] **JWT トークン生成** _(golang-jwt/jwt/v5)_
- [ ] **JWT 検証ミドルウェア** _(トークン検証)_
- [ ] **カスタムクレーム** _(ユーザー情報、権限情報)_
- [ ] **トークン無効化** _(revoked_tokens テーブル)_
- [ ] **リフレッシュトークン** _(セキュアなトークン更新)_

### **4.2 Permission Matrix実装**

- [ ] **権限マトリックス定義** _(Module × Action)_
- [ ] **動的権限チェック** _(ミドルウェア)_
- [ ] **階層ロール継承** _(親ロール権限継承)_
- [ ] **スコープベース権限** _(部署・リソース制限)_

### **4.3 Policy Object実装**

- [ ] **ポリシーインターフェース** _(戦略パターン)_
- [ ] **時間制限ポリシー** _(time_restrictions)_
- [ ] **IP制限ポリシー** _(audit_logs IP検証)_
- [ ] **承認フローポリシー** _(approval_states)_
- [ ] **動的ポリシー切り替え** _(DI注入)_

---

## 🏢 **Phase 5: ビジネスロジック実装**

### **5.1 ユーザー管理API**

- [ ] **POST /api/v1/users** _(ユーザー作成)_
- [ ] **GET /api/v1/users** _(ユーザー一覧)_
- [ ] **GET /api/v1/users/:id** _(ユーザー詳細)_
- [ ] **PUT /api/v1/users/:id** _(ユーザー更新)_
- [ ] **DELETE /api/v1/users/:id** _(ユーザー削除)_
- [ ] **PUT /api/v1/users/:id/status** _(ステータス変更)_

### **5.2 部署管理API**

- [ ] **POST /api/v1/departments** _(部署作成)_
- [ ] **GET /api/v1/departments** _(部署一覧・階層)_
- [ ] **GET /api/v1/departments/:id** _(部署詳細)_
- [ ] **PUT /api/v1/departments/:id** _(部署更新)_
- [ ] **DELETE /api/v1/departments/:id** _(部署削除)_

### **5.3 ロール・権限管理API**

- [ ] **POST /api/v1/roles** _(ロール作成)_
- [ ] **GET /api/v1/roles** _(ロール一覧)_
- [ ] **PUT /api/v1/roles/:id/permissions** _(権限割り当て)_
- [ ] **GET /api/v1/permissions** _(権限マトリックス取得)_

---

## 🛡️ **Phase 6: セキュリティ強化**

### **6.1 セキュリティ機能**

- [ ] **パスワードハッシュ化** _(bcrypt)_
- [ ] **入力値検証** _(go-playground/validator)_
- [ ] **SQLインジェクション対策** _(GORM自動エスケープ)_
- [ ] **XSS対策** _(セキュリティヘッダー)_

### **6.2 監査・ログ**

- [ ] **監査ログ記録** _(成功・失敗・エラー)_
- [ ] **IP・User-Agent記録** _(audit_logs)_
- [ ] **アクセスログ** _(リクエスト・レスポンス)_
- [ ] **エラー追跡** _(構造化ログ)_

---

## 📊 **Phase 7: 監視・運用**

### **7.1 メトリクス・モニタリング**

- [ ] **Prometheus メトリクス** _(API レスポンス時間、エラー率)_
- [ ] **ヘルスチェックエンドポイント** _(/health, /ready)_
- [ ] **データベースヘルスチェック** _(接続状態監視)_
- [ ] **システムメトリクス** _(メモリ、CPU使用率)_

### **7.2 パフォーマンス**

- [ ] **データベースインデックス最適化** _(02.sql定義済み)_
- [ ] **N+1クエリ対策** _(GORM Preload)_
- [ ] **キャッシュ戦略** _(Redis導入検討)_
- [ ] **レスポンス時間最適化** _(ページネーション)_

---

## 🧪 **Phase 8: テスト実装**

### **8.1 ユニットテスト**

- [ ] **モデルテスト** _(GORM モデル検証)_
- [ ] **サービスレイヤーテスト** _(ビジネスロジック)_
- [ ] **ミドルウェアテスト** _(認証・認可)_
- [ ] **ユーティリティテスト** _(ヘルパー関数)_

### **8.2 統合テスト**

- [ ] **API エンドポイントテスト** _(httptest)_
- [ ] **データベーステスト** _(testcontainers)_
- [ ] **JWT認証フローテスト** _(E2E)_
- [ ] **権限チェックテスト** _(アクセス制御)_

---

## 📚 **Phase 9: ドキュメント・デプロイ**

### **9.1 ドキュメント**

- [ ] **API仕様書** _(OpenAPI完全版)_
- [ ] **README.md** _(プロジェクト概要・セットアップ手順)_
- [ ] **デプロイ手順書** _(Docker/K8s)_
- [ ] **運用マニュアル** _(トラブルシューティング)_

### **9.2 デプロイメント**

- [ ] **Dockerfile** _(マルチステージビルド)_
- [ ] **docker-compose.yml** _(PostgreSQL含む)_
- [ ] **CI/CD設定** _(GitHub Actions)_
- [ ] **Kubernetes マニフェスト** _(本番デプロイ用)_

---

## 🎯 **完了基準**

### **✅ 最小限実装 (MVP)**
- [x] 設計完了
- [ ] 基本CRUD API (User, Department, Role)
- [ ] JWT認証
- [ ] 基本的な権限チェック
- [ ] 監査ログ
- [ ] OpenAPI仕様書

### **🚀 本格運用 (Production Ready)**
- [ ] 全API実装
- [ ] 包括的テストカバレッジ (>80%)
- [ ] セキュリティ監査
- [ ] パフォーマンステスト
- [ ] 監視・アラート設定
- [ ] ドキュメント完備

---

## 📈 **進捗管理**

| Phase | 完了率 | 重要度 | 期間目安 |
|-------|--------|--------|----------|
| **Phase 1** | 43% | 🔴 高 | 1-2日 |
| **Phase 2** | 33% | 🔴 高 | 2-3日 |
| **Phase 3** | 0% | 🔴 高 | 3-4日 |
| **Phase 4** | 0% | 🟡 中 | 5-7日 |
| **Phase 5** | 0% | 🟡 中 | 7-10日 |
| **Phase 6** | 0% | 🔴 高 | 2-3日 |
| **Phase 7** | 0% | 🟢 低 | 2-3日 |
| **Phase 8** | 0% | 🟡 中 | 5-7日 |
| **Phase 9** | 0% | 🟢 低 | 2-3日 |

**総開発期間見積もり**: 約 **4-6週間** (フルタイム開発想定)

---

## 🔄 **更新履歴**

| 日付 | 更新内容 | 担当者 |
|------|----------|--------|
| 2025-01-15 | 初版作成・Phase1-9定義 | System |
| - | - | - |

---

**🎯 次のステップ**: `docs/design/access_control/04_roadmap.md` でSTEP別開発計画を策定
