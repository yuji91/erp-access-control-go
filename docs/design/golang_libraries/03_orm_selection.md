# ERPå‘ã‘ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡API - ORMãƒ»ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é¸å®š

ERPã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã‚·ã‚¹ãƒ†ãƒ ã«ãŠã‘ã‚‹ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œã§ã¯ã€ä»¥ä¸‹ã®æ§‹æˆãŒéå¸¸ã«é©åˆ‡ã§ã™ã€‚

## âœ… çµè«–ï¼šgorm + golang-migrate/migrate ã®ä½µç”¨ãŒæœ€é©

| ãƒ©ã‚¤ãƒ–ãƒ©ãƒª | å½¹å‰² | æ¡ç”¨ç†ç”± |
|-----------|------|----------|
| gorm | ORMï¼ˆæ§‹é€ ä½“ â‡” DBï¼‰ | å‹å®‰å…¨ã§æŸ”è»Ÿãªã‚¯ã‚¨ãƒªæ§‹ç¯‰ãŒå¯èƒ½ã€‚init_migration_erp_acl.sql ã®æ§‹é€ ã«å¯¾å¿œã—ãŸãƒ¢ãƒ‡ãƒ«ãŒçµ„ã‚ã‚‹ã€‚ |
| golang-migrate/migrate | ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç®¡ç†ï¼ˆSQLï¼‰ | æ˜ç¤ºçš„ãªãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ã¨å±¥æ­´ã®è¨˜éŒ²ãŒå¯èƒ½ã€‚GORMã®AutoMigrateã«ä¾å­˜ã—ãªã„å …ç‰¢ãªé‹ç”¨ãŒå¯èƒ½ã€‚ |

## ğŸ” æ¡ç”¨æ§‹æˆã®è£œè¶³

### gorm ã®åˆ©ç”¨ãƒã‚¤ãƒ³ãƒˆ
- `users`, `roles`, `permissions` ãªã©ã‚’Goæ§‹é€ ä½“ã§å®šç¾©ã—ã€GORMã‚¿ã‚°ã§DBã‚¹ã‚­ãƒ¼ãƒã¨å¯¾å¿œã•ã›ã‚‹
- é–¢é€£æ§‹é€ ï¼ˆbelongsTo, hasManyï¼‰ã«ã‚‚å¯¾å¿œ
- ABACãƒ»RBACã®ã‚¹ã‚³ãƒ¼ãƒ—åˆ¤æ–­ã«å¿…è¦ãª `user_scopes`, `approval_states` ãªã©ã®å‹•çš„ã‚¯ã‚¨ãƒªã‚‚çµ„ã¿ã‚„ã™ã„

### golang-migrate ã®åˆ©ç”¨ãƒã‚¤ãƒ³ãƒˆ
- `init_migration_erp_acl.sql` ã‚’ `0001_init_schema.up.sql` ã«ã—ã¦åˆæœŸãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«ä½¿ç”¨
- æ‰‹å‹•ã§DDLã‚’å®šç¾©ã™ã‚‹ã“ã¨ã§ã€ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ ã®åˆ¶å¾¡ã¨ç›£æŸ»ãŒã—ã‚„ã™ã„
- ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å±¥æ­´ï¼ˆschema_migrationsï¼‰ã«ã‚ˆã£ã¦å®‰å…¨ãªç§»è¡Œç®¡ç†ãŒå¯èƒ½

## ğŸ› ï¸ æ¨å¥¨æ§‹æˆãƒ»é‹ç”¨ãƒ•ãƒ­ãƒ¼

### ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä¾‹

```
.
â”œâ”€â”€ migrations/
â”‚   â”œâ”€â”€ 0001_init_schema.up.sql
â”‚   â””â”€â”€ 0001_init_schema.down.sql
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ user.go
â”‚   â”œâ”€â”€ role.go
â”‚   â””â”€â”€ ...
â”œâ”€â”€ internal/db/
â”‚   â””â”€â”€ connect.go
```

### ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒãƒ³ãƒ‰ï¼ˆä¾‹ï¼‰

```bash
# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
migrate -path ./migrations -database "postgres://user:pass@localhost:5432/dbname?sslmode=disable" up

# ãƒ€ã‚¦ãƒ³
migrate -path ./migrations -database ... down 1
```

## âœ¨ ãªãœä½µç”¨ãŒè‰¯ã„ã®ã‹ï¼Ÿ

| ç›®çš„ | GORM | golang-migrate |
|------|------|----------------|
| ã‚¯ã‚¨ãƒªæ§‹ç¯‰ | âœ… | âŒï¼ˆSQLæ‰‹æ›¸ãï¼‰ |
| ãƒ‡ãƒ¼ã‚¿æ“ä½œ | âœ… | âŒ |
| ã‚¹ã‚­ãƒ¼ãƒæ›´æ–° | âš ï¸ï¼ˆAutoMigrateã¯æš—é»™çš„ï¼‰ | âœ…ï¼ˆSQLã§æ˜ç¤ºç®¡ç†ï¼‰ |
| ãƒãƒ¼ãƒ é–‹ç™º | âš ï¸ï¼ˆå¤‰æ›´ã®è¨˜éŒ²ãŒè–„ã„ï¼‰ | âœ…ï¼ˆå±¥æ­´ã§ç®¡ç†ãƒ»å…±æœ‰ãŒå®¹æ˜“ï¼‰ |
| æœ¬ç•ªé‹ç”¨ | âŒï¼ˆAutoMigrateã¯å±é™ºï¼‰ | âœ…ï¼ˆãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ã§å®‰å…¨ï¼‰ |

â†’ GORMã¯å®Ÿè¡Œæ™‚ã®æ“ä½œã€migrateã¯ç§»è¡Œã¨å±¥æ­´ç®¡ç†ã«ç‰¹åŒ–ã€‚ãã‚Œãã‚Œã®å¼·ã¿ã‚’æ´»ã‹ã›ã¾ã™ã€‚

## âœ… ã¾ã¨ã‚

| é …ç›® | æ¨å¥¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª | å‚™è€ƒ |
|------|---------------|------|
| ORMãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ | gorm | å‹å®‰å…¨ã€æ§‹é€ ä½“ãƒ™ãƒ¼ã‚¹ã®æŸ”è»Ÿãªã‚¯ã‚¨ãƒªç”Ÿæˆ |
| ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç®¡ç† | golang-migrate/migrate | æ‰‹å‹•SQLã§ã®ç¢ºå®Ÿãªãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç®¡ç† |
| åˆæœŸã‚¹ã‚­ãƒ¼ãƒé€£æº | âœ… init_migration_erp_acl.sql ã‚’ãã®ã¾ã¾ .up.sql ã«å¤‰æ›å¯èƒ½ | ã‚¹ãƒ ãƒ¼ã‚ºã«åˆæœŸå°å…¥å¯èƒ½ |

ã”å¸Œæœ›ã§ã‚ã‚Œã°ã€gorm ãƒ¢ãƒ‡ãƒ«å®šç¾©ï¼ˆæ§‹é€ ä½“ï¼‰ï¼‹ golang-migrate åˆæœŸã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè£…ä¾‹ã‚‚æç¤ºå¯èƒ½ã§ã™ã€‚å¿…è¦ã§ã—ãŸã‚‰ãŠç”³ã—ä»˜ã‘ãã ã•ã„ã€‚

---

## Ginæ¡ç”¨æ™‚ã®æ§‹æˆã«ã¤ã„ã¦

Ginã‚’æ¡ç”¨ã™ã‚‹å ´åˆã§ã‚‚ã€gorm + golang-migrate/migrate ã®ä½µç”¨æ–¹é‡ã¯ãã®ã¾ã¾æœ‰åŠ¹ã‹ã¤æ¨å¥¨ã§ã™ã€‚ã‚€ã—ã‚Ginã¨ã®çµ„ã¿åˆã‚ã›ã«ã‚ˆã‚Šã€ç–çµåˆãƒ»è²¬å‹™åˆ†é›¢ã•ã‚ŒãŸãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ§‹æˆã‚’å®Ÿç¾ã—ã‚„ã™ããªã‚Šã¾ã™ã€‚

### âœ… Ginæ¡ç”¨æ™‚ã®æ§‹æˆï¼šgorm + migrate ã®çµ±åˆæ¡ˆ

| ãƒ¬ã‚¤ãƒ¤ | å½¹å‰² | å‚™è€ƒ |
|--------|------|------|
| main.go | DBæ¥ç¶š + Ginãƒ«ãƒ¼ã‚¿ãƒ¼åˆæœŸåŒ– | DBæ¥ç¶šã‚’DIï¼ˆä¾å­˜æ³¨å…¥ï¼‰ã§ handlers ã«æ¸¡ã™ |
| models/ | GORMãƒ¢ãƒ‡ãƒ« | User, Role, Permission ãªã©ã‚’å®šç¾© |
| handlers/ | APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆGinï¼‰ | GET /me/permissions, POST /resources/... ã‚’æ‹…å½“ |
| services/ | ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ãƒ»ãƒãƒªã‚·ãƒ¼è©•ä¾¡ | DBã‚¯ã‚¨ãƒª + æ¨©é™åˆ¤å®šï¼ˆPolicyObjectï¼‰ |
| migrations/ | SQLãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†ï¼ˆgolang-migrateï¼‰ | init_migration_erp_acl.sql ã‹ã‚‰ä½œæˆå¯èƒ½ |

### ğŸ“‚ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆä¾‹ï¼ˆGin + GORM + Migrateï¼‰

```
.
â”œâ”€â”€ main.go
â”œâ”€â”€ config/
â”‚   â””â”€â”€ config.go         # DBæ¥ç¶šè¨­å®š
â”œâ”€â”€ db/
â”‚   â””â”€â”€ connect.go        # GORM + DBæ¥ç¶šç”¨
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ user.go
â”‚   â”œâ”€â”€ permission.go
â”‚   â””â”€â”€ ...
â”œâ”€â”€ handlers/
â”‚   â”œâ”€â”€ permissions.go
â”‚   â””â”€â”€ resources.go
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ policy.go
â”‚   â””â”€â”€ matrix_loader.go
â”œâ”€â”€ middleware/
â”‚   â””â”€â”€ auth.go
â”œâ”€â”€ routes/
â”‚   â””â”€â”€ router.go         # Ginã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¨­å®š
â”œâ”€â”€ migrations/
â”‚   â””â”€â”€ 0001_init_schema.up.sql
â”œâ”€â”€ go.mod
â””â”€â”€ go.sum
```

### ğŸ”§ Gin Ã— GORM çµ±åˆãƒã‚¤ãƒ³ãƒˆï¼ˆä¾‹ï¼‰

```go
// db/connect.go
func ConnectDB() *gorm.DB {
  dsn := os.Getenv("DATABASE_URL")
  db, err := gorm.Open(postgres.Open(dsn), &gorm.Config{})
  if err != nil {
    log.Fatalf("DBæ¥ç¶šã‚¨ãƒ©ãƒ¼: %v", err)
  }
  return db
}
```

```go
// main.go
func main() {
  db := db.ConnectDB()
  router := routes.SetupRouter(db)
  router.Run(":8080")
}
```

```go
// handlers/permissions.go
func GetUserPermissions(c *gin.Context) {
  db := c.MustGet("db").(*gorm.DB)
  userID := c.GetString("userID")

  // Permissionå–å¾—å‡¦ç†
  var permissions []models.Permission
  db.Joins("JOIN role_permissions ...").
    Where("users.id = ?", userID).
    Find(&permissions)

  c.JSON(http.StatusOK, gin.H{"permissions": permissions})
}
```

### ğŸ§ª ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é‹ç”¨ä¾‹ï¼ˆSQLç®¡ç†ï¼‰

```bash
# åˆå›ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç™»éŒ²ï¼ˆinit_migration_erp_acl.sqlã‚’ä½¿ã†ï¼‰
cp init_migration_erp_acl.sql migrations/0001_init_schema.up.sql

# golang-migrate ã‚³ãƒãƒ³ãƒ‰
migrate -path ./migrations -database "$DATABASE_URL" up
```

GORMã® `AutoMigrate()` ã¯é–‹ç™ºåˆæœŸã«ã¯ä¾¿åˆ©ã§ã™ãŒã€æœ¬ç•ªç’°å¢ƒã§ã¯ SQLãƒ™ãƒ¼ã‚¹ã®æ˜ç¤ºçš„ãªç®¡ç†ï¼ˆmigrateï¼‰ ãŒæœ›ã¾ã‚Œã¾ã™ã€‚

### âœ… Ginæ§‹æˆã§ã‚‚ãƒ™ã‚¹ãƒˆãªç†ç”±

| é …ç›® | gorm + migrate | ç†ç”±ï¼ˆGinæ§‹æˆã«ãŠã„ã¦ï¼‰ |
|------|----------------|----------------------|
| DBæ“ä½œ | gorm | ãƒãƒ³ãƒ‰ãƒ©ã‚„ã‚µãƒ¼ãƒ“ã‚¹å±¤ã‹ã‚‰ã‚·ãƒ³ãƒ—ãƒ«ã«ã‚¯ã‚¨ãƒªå®Ÿè¡Œ |
| ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ | golang-migrate | SQLã§ã®å³æ ¼ãªç®¡ç†ã¨å±¥æ­´è¿½è·¡ãŒå¯èƒ½ |
| Giné€£æº | OK | *gorm.DB ã‚’ c.Set("db", db) ã§æ¸¡ã—ã¦ä½¿ç”¨å¯èƒ½ |
| ãƒ†ã‚¹ãƒˆæ€§ | é«˜ | DBã ã‘ãƒ¢ãƒƒã‚¯ã—ã¦ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‚’ç‹¬ç«‹ã—ã¦ãƒ†ã‚¹ãƒˆå¯èƒ½ |

## âœ¨ ç·ã¾ã¨ã‚ï¼šGinæ§‹æˆã§ã®å½¹å‰²åˆ†æ‹…

| å±¤ | ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ / ãƒ©ã‚¤ãƒ–ãƒ©ãƒª | å‚™è€ƒ |
|----|---------------------------|------|
| ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚° / API | gin-gonic/gin | å„ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå®šç¾©ï¼ˆRESTï¼‰ |
| ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ / UI | swaggo/swag | Swagger UIç”Ÿæˆ |
| ORM | gorm | ãƒ¢ãƒ‡ãƒ«å®šç¾© + ã‚¯ã‚¨ãƒªæ§‹ç¯‰ |
| ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ | golang-migrate/migrate | æ˜ç¤ºçš„ãªDDLåˆ¶å¾¡ã€å±¥æ­´è¿½è·¡ |
| æ¨©é™è©•ä¾¡ | ç‹¬è‡ª PolicyResolver | RBAC/ABACå¯¾å¿œã®åˆ¤æ–­ãƒ­ã‚¸ãƒƒã‚¯ |

å¿…è¦ã§ã‚ã‚Œã° `models.User` ã‚„ `0001_init_schema.up.sql` ã¸ã®å¤‰æ›ä¾‹ã€Ginç”¨ã®ä¾å­˜æ³¨å…¥ã‚³ãƒ¼ãƒ‰ä¾‹ã‚‚ã™ãã”æä¾›ã§ãã¾ã™ã€‚ã”å¸Œæœ›ãŒã‚ã‚Œã°ã©ã†ãã€‚


